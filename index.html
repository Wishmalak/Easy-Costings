<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recipe Builder</title>
  <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, input { margin: 5px; padding: 5px; }
    #ingredient-list div { margin-bottom: 10px; }
    button { margin: 5px; padding: 5px 10px; }
  </style>
</head>
<body>
  <h1>Create Your Recipe</h1>

  <!-- Ingredient rows -->
  <div id="ingredient-list"></div>

  <!-- Buttons for adding ingredients and calculating -->
  <button onclick="addIngredient()">+ Add Ingredient</button>
  <button onclick="calculateTotal()">Calculate Cost</button>

  <h3>Recipe Settings</h3>
  <label>
    Yield (portions):
    <input type="number" id="yield" value="1" min="1">
  </label><br>
  <label>
    Wastage (%):
    <input type="number" id="wastage" value="0" min="0" max="100">
  </label><br>

  <h3>Result</h3>
  <pre id="total-output"></pre>

  <!-- Tom Select JS -->
  <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>

  <script>
    const API_URL = "https://script.google.com/macros/s/AKfycbw-JT6d9sVkxXSB9-oBDTGauDjg_UV5f9AG3ZofAH9sq5UWh4ohXOZd9y0LbcOn0Y3CHw/exec";
    let ingredientsData = [];

    // On load, fetch ingredient list then add first row
    fetch(`${API_URL}?list=ingredients`)
      .then(res => {
        if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
        return res.json();
      })
      .then(data => {
        ingredientsData = data;
        addIngredient();
      })
      .catch(err => console.error("Error loading ingredients:", err));

    function addIngredient() {
      const container = document.getElementById("ingredient-list");
      const row = document.createElement("div");

      const select = document.createElement("select");
      select.className = "ingredient-dropdown";
      ingredientsData.forEach(({ name, unit }) => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = `${name} (${unit})`;
        select.appendChild(opt);
      });

      const qtyInput = document.createElement("input");
      qtyInput.type = "number";
      qtyInput.placeholder = "Qty";
      qtyInput.style.marginLeft = "5px";

      row.append(select, qtyInput);
      container.appendChild(row);

      new TomSelect(select, {
        create: false,
        sortField: {
          field: "text",
          direction: "asc"
        },
        placeholder: "Type to search..."
      });
    }

    function calculateTotal() {
      const yieldVal = Number(document.getElementById("yield").value) || 1;
      const wastage  = (Number(document.getElementById("wastage").value) || 0) / 100;
      let totalCost  = 0;

      document.querySelectorAll("#ingredient-list > div").forEach(row => {
        const name = row.querySelector("select").value;
        const qty  = Number(row.querySelector("input").value) || 0;
        const ingredient = ingredientsData.find(i => i.name === name);
        if (ingredient) totalCost += qty * ingredient.costPerUnit;
      });

      const adjusted   = totalCost / (1 - wastage);
      const perPortion = adjusted / yieldVal;

      document.getElementById("total-output").textContent =
        `Total Cost: $${totalCost.toFixed(2)}\n` +
        `Adjusted (with wastage): $${adjusted.toFixed(2)}\n` +
        `Cost per Portion: $${perPortion.toFixed(2)}`;
    }
  </script>
</body>
</html>
